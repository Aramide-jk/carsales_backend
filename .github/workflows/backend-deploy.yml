name: Backend CI/CD - Production

on:
  push:
    branches:
      - main   # Only deploy from main

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
    # 1Ô∏è‚É£ Checkout code
    - name: Checkout repository
      uses: actions/checkout@v3

    # 2Ô∏è‚É£ Setup Node
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 20

    # 3Ô∏è‚É£ Install dependencies
    - name: Install dependencies
      run: npm ci

    # 4Ô∏è‚É£ Run lint and tests
    - name: Run Tests & Lint
      run: |
        npm run lint
        npm test
      env:
        NODE_ENV: test
        MONG_URI: ${{ secrets.MONG_URI }}

    # 5Ô∏è‚É£ Build Docker image
    - name: Build Docker image
      run: docker build -t backend:${{ github.sha }} .

    # 6Ô∏è‚É£ Login to AWS ECR
    - name: Login to AWS ECR
      uses: aws-actions/amazon-ecr-login@v2
      with:
        region: ${{ secrets.AWS_REGION }}

    # 7Ô∏è‚É£ Tag Docker image
    - name: Tag Docker image
      run: docker tag backend:${{ github.sha }} ${{ secrets.AWS_ECR_URI }}:${{ github.sha }}

    # 8Ô∏è‚É£ Push Docker image to ECR
    - name: Push Docker image
      run: docker push ${{ secrets.AWS_ECR_URI }}:${{ github.sha }}

    # 9Ô∏è‚É£ Update ECS Task Definition & Deploy
    - name: Deploy to ECS
      uses: aws-actions/amazon-ecs-deploy-task-definition@v1
      with:
        service: backend-service         # Your ECS Service Name
        cluster: jk-cluster         # Your ECS Cluster Name
        task-definition: task-def.json
        wait-for-service-stability: true

    # üîπ Optional: Run DB Migrations
    - name: Run Database Migrations
      run: npm run migrate:prod
      env:
        NODE_ENV: production
        MONG_URI: ${{ secrets.MONG_URI }}
