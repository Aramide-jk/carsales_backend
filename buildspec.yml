version: 0.2

env:
  parameter-store:
    BASE_AMI: /backend/base-ami-id
    SUBNET_ID: /backend/subnet-id
    SG_ID: /backend/security-group-id
    IAM_PROFILE: /backend/iam-profile
    LAUNCH_TEMPLATE: /backend/launch-template
    ASG_NAME: /backend/asg-name
    
phases:
  install:
    runtime-versions:
      nodejs: 20
    commands:
      - echo "Installing dependencies..."
      - npm ci
  build:
    commands:
      - echo "Building backend application..."
      - npm run build
      - zip -r backend.zip .
      - echo "Uploading backend.zip to S3..."
      - aws s3 cp backend.zip s3://backend-artifacts-2025/backend.zip
  post_build:
    commands:
      - echo "Starting backend AMI bake..."
      - echo "Launching temporary EC2 instance..."
      - INSTANCE_ID=$(aws ec2 run-instances --image-id "$BASE_AMI" --instance-type t2.micro --subnet-id "$SUBNET_ID" --security-group-ids "$SG_ID" --query "Instances[0].InstanceId" --output text)
      - echo "Temporary instance launched $INSTANCE_ID"
      - echo "Waiting for instance to be ready..."
      - aws ec2 wait instance-running --instance-ids "$INSTANCE_ID"
      - aws ssm wait instance-online --instance-ids "$INSTANCE_ID"
      - echo "Deploying backend via SSM..."
      - aws ssm send-command --instance-ids "$INSTANCE_ID" --document-name AWS-RunShellScript --parameters commands="['cd /opt/backend','rm -rf *','aws s3 cp s3://backend-artifacts-2025/backend.zip .','unzip backend.zip','npm install --omit=dev','npm run build','sudo systemctl restart backend']"
      - echo "Creating new AMI..."
      - AMI_ID=$(aws ec2 create-image --instance-id "$INSTANCE_ID" --name "backend-ami-$(date +%s)" --no-reboot --query ImageId --output text)
      - echo "New AMI created $AMI_ID"
      - aws ec2 wait image-available --image-ids "$AMI_ID"
      - echo "Updating Launch Template..."
      - aws ec2 modify-launch-template --launch-template-name "$LAUNCH_TEMPLATE" --default-version --launch-template-data ImageId="$AMI_ID"
      - echo "Triggering ASG rolling refresh..."
      - aws autoscaling start-instance-refresh --auto-scaling-group-name "$ASG_NAME" --strategy Rolling --preferences MinHealthyPercentage=50
      - echo "Terminating temporary instance..."
      - aws ec2 terminate-instances --instance-ids "$INSTANCE_ID"
      - echo "Backend AMI bake and ASG refresh completed successfully."
