version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 20
    commands:
      - echo "Installing dependencies"
      - npm ci

  build:
    commands:
      - echo "Building application"
      - npm run build
      - zip -r backend.zip .

  post_build:
    commands:
      - |
        echo "Build started"

        INSTANCE_ID=$(aws ec2 run-instances \
          --image-id "$BASE_AMI" \
          --instance-type t2.micro \
          --subnet-id "$SUBNET_ID" \
          --security-group-ids "$SG_ID" \
          --iam-instance-profile Name="$IAM_PROFILE" \
          --query "Instances[0].InstanceId" \
          --output text)

        echo "Temp instance: $INSTANCE_ID"

        aws ec2 wait instance-running --instance-ids "$INSTANCE_ID"
        aws ssm wait instance-online --instance-ids "$INSTANCE_ID"

        aws ssm send-command \
          --instance-ids "$INSTANCE_ID" \
          --document-name AWS-RunShellScript \
          --parameters commands="[
            'cd /opt/backend',
            'unzip -o backend.zip',
            'npm install --omit=dev',
            'npm run build',
            'sudo systemctl restart backend'
          ]"

        AMI_ID=$(aws ec2 create-image \
          --instance-id "$INSTANCE_ID" \
          --name backend-ami-$(date +%s) \
          --no-reboot \
          --query ImageId \
          --output text)

        echo "AMI created: $AMI_ID"

        aws ec2 wait image-available --image-ids "$AMI_ID"

        aws ec2 modify-launch-template \
          --launch-template-name "$LAUNCH_TEMPLATE" \
          --default-version \
          --launch-template-data ImageId="$AMI_ID"

        aws autoscaling start-instance-refresh \
          --auto-scaling-group-name "$ASG_NAME" \
          --strategy Rolling \
          --preferences MinHealthyPercentage=50

        aws ec2 terminate-instances --instance-ids "$INSTANCE_ID"
