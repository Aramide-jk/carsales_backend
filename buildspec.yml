version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 20
    commands:
      - echo "Installing dependencies..."
      - npm ci
      
  build:
    commands:
      - echo "Building application..."
      - npm run build
      - echo "Creating deployment package..."
      - zip -r backend.zip . -x "*.git*" -x "node_modules/*" -x "*.zip"
      
  post_build:
    commands:
      - echo "=== Starting AMI Bake Process ==="
      - echo "BASE_AMI=$BASE_AMI"
      - echo "SUBNET_ID=$SUBNET_ID"
      - echo "SG_ID=$SG_ID"
      
      - echo "Verifying required environment variables..."
      - |
        if [ -z "$BASE_AMI" ] || [ -z "$SUBNET_ID" ] || [ -z "$SG_ID" ]; then
          echo "ERROR: Required environment variables not set"
          exit 1
        fi
      
      - echo "Launching temporary EC2 instance..."
      - |
        INSTANCE_ID=$(aws ec2 run-instances \
          --image-id "$BASE_AMI" \
          --instance-type t2.micro \
          --subnet-id "$SUBNET_ID" \
          --security-group-ids "$SG_ID" \
          --iam-instance-profile Name="$IAM_PROFILE" \
          --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=CodeBuild-Temp-Instance}]' \
          --query "Instances[0].InstanceId" \
          --output text)
        
        if [ -z "$INSTANCE_ID" ]; then
          echo "ERROR: Failed to launch instance"
          exit 1
        fi
        
        echo "Instance launched: $INSTANCE_ID"
      
      - echo "Waiting for instance to be running..."
      - aws ec2 wait instance-running --instance-ids $INSTANCE_ID
      
      - echo "Instance is running. Waiting 60 seconds for SSM agent..."
      - sleep 60
      
      - echo "Sending deployment commands via SSM..."
      - |
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$INSTANCE_ID" \
          --document-name "AWS-RunShellScript" \
          --parameters 'commands=["cd /opt/backend","unzip -o backend.zip","npm install --omit=dev","npm run build","sudo systemctl restart backend"]' \
          --query "Command.CommandId" \
          --output text)
        
        echo "Command ID: $COMMAND_ID"
      
      - echo "Waiting 30 seconds for command execution..."
      - sleep 30
      
      - echo "Creating AMI from instance..."
      - |
        TIMESTAMP=$(date +%s)
        AMI_ID=$(aws ec2 create-image \
          --instance-id "$INSTANCE_ID" \
          --name "backend-ami-$TIMESTAMP" \
          --description "Backend AMI created at $TIMESTAMP" \
          --no-reboot \
          --query ImageId \
          --output text)
        
        echo "AMI created: $AMI_ID"
      
      - echo "Waiting for AMI to be available..."
      - aws ec2 wait image-available --image-ids $AMI_ID
      
      - echo "AMI is ready. Updating launch template..."
      - |
        aws ec2 modify-launch-template \
          --launch-template-name "$LAUNCH_TEMPLATE" \
          --launch-template-data ImageId="$AMI_ID"
      
      - echo "Starting Auto Scaling Group instance refresh..."
      - |
        aws autoscaling start-instance-refresh \
          --auto-scaling-group-name "$ASG_NAME" \
          --strategy Rolling \
          --preferences MinHealthyPercentage=50
      
      - echo "Terminating temporary instance..."
      - aws ec2 terminate-instances --instance-ids $INSTANCE_ID
      
      - echo "=== AMI Bake Completed Successfully ==="
      - echo "New AMI ID: $AMI_ID"

artifacts:
  files:
    - backend.zip

cache:
  paths:
    - 'node_modules/**/*'
