version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 20
    commands:
      - echo "Installing dependencies..."
      - npm ci

  build:
    commands:
      - echo "Building backend application..."
      - npm run build
      - zip -r backend.zip .
      - echo "Uploading backend.zip to S3..."
      - aws s3 cp backend.zip s3://backend-artifacts-2025/backend.zip

  post_build:
    commands:
      - echo "Starting backend AMI bake..."

      # Launch temporary EC2 instance
      - INSTANCE_ID=$(aws ec2 run-instances \
          --image-id "$BASE_AMI" \
          --instance-type t2.micro \
          --subnet-id "$SUBNET_ID" \
          --security-group-ids "$SG_ID" \
          --iam-instance-profile Name="$IAM_PROFILE" \
          --query "Instances[0].InstanceId" \
          --output text)
      - echo "Temporary instance launched: $INSTANCE_ID"

      # Wait until instance is ready
      - aws ec2 wait instance-running --instance-ids "$INSTANCE_ID"
      - aws ssm wait instance-online --instance-ids "$INSTANCE_ID"

      # Deploy backend via SSM (download from S3)
      - |
        aws ssm send-command \
          --instance-ids "$INSTANCE_ID" \
          --document-name AWS-RunShellScript \
          --parameters commands="[
            'cd /opt/backend',
            'rm -rf *',
            'aws s3 cp s3://backend-artifacts-2025/backend.zip .',
            'unzip backend.zip',
            'npm install --omit=dev',
            'npm run build',
            'sudo systemctl restart backend'
          ]"

      # Create new AMI
      - |
        AMI_ID=$(aws ec2 create-image \
          --instance-id "$INSTANCE_ID" \
          --name "backend-ami-$(date +%s)" \
          --no-reboot \
          --query ImageId \
          --output text)
      - echo "New AMI created: $AMI_ID"

      - aws ec2 wait image-available --image-ids "$AMI_ID"

      # Update Launch Template to use new AMI
      - aws ec2 modify-launch-template \
          --launch-template-name "$LAUNCH_TEMPLATE" \
          --default-version \
          --launch-template-data ImageId="$AMI_ID"

      # Trigger rolling instance refresh on ASG
      - aws autoscaling start-instance-refresh \
          --auto-scaling-group-name "$ASG_NAME" \
          --strategy Rolling \
          --preferences MinHealthyPercentage=50

      # Terminate temporary instance
      - aws ec2 terminate-instances --instance-ids "$INSTANCE_ID"

      - echo "Backend AMI bake and ASG refresh completed successfully."
